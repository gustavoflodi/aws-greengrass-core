#!/bin/bash

echo "üîç === DIAGN√ìSTICO COMPLETO AWS GREENGRASS V2 ==="
echo "Data/Hora: $(date)"
echo "Account ID: 864899849825"
echo "Thing Name: MeuCoreWSLDockerV2"
echo "Regi√£o: us-east-1"
echo "=========================================================="

# Fun√ß√£o para verificar comando
check_command() {
    if command -v $1 &> /dev/null; then
        echo "‚úÖ $1 est√° dispon√≠vel"
        return 0
    else
        echo "‚ùå $1 N√ÉO est√° dispon√≠vel"
        return 1
    fi
}

# 1. Verificar ferramentas b√°sicas
echo -e "\nüõ†Ô∏è  === VERIFICA√á√ÉO DE FERRAMENTAS ==="
check_command aws
check_command docker
check_command jq

# 2. Verificar conectividade AWS
echo -e "\nüåê === VERIFICA√á√ÉO DE CONECTIVIDADE AWS ==="
echo "üîÑ Testando credenciais AWS..."
if aws sts get-caller-identity > /dev/null 2>&1; then
    ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
    USER=$(aws sts get-caller-identity --query Arn --output text)
    echo "‚úÖ Conectado √† AWS"
    echo "   Conta: $ACCOUNT"
    echo "   Usu√°rio: $USER"
else
    echo "‚ùå Falha na conectividade AWS"
    echo "üí° Verifique: aws configure"
    exit 1
fi

# 3. Verificar Thing IoT
echo -e "\nüì± === VERIFICA√á√ÉO DO AWS IOT THING ==="
if aws iot describe-thing --thing-name MeuCoreWSLDockerV2 --region us-east-1 > /dev/null 2>&1; then
    echo "‚úÖ Thing 'MeuCoreWSLDockerV2' encontrado"
    
    # Verificar certificados
    CERT_COUNT=$(aws iot list-thing-principals --thing-name MeuCoreWSLDockerV2 --region us-east-1 --query 'length(principals)' --output text)
    echo "   Certificados associados: $CERT_COUNT"
    
else
    echo "‚ùå Thing 'MeuCoreWSLDockerV2' n√£o encontrado"
    echo "üí° Verifique se o Thing foi criado corretamente"
fi

# 4. Verificar Core Device
echo -e "\nüñ•Ô∏è  === VERIFICA√á√ÉO DO CORE DEVICE ==="
if aws greengrassv2 get-core-device --core-device-thing-name MeuCoreWSLDockerV2 --region us-east-1 > /dev/null 2>&1; then
    echo "‚úÖ Core Device encontrado"
    
    STATUS=$(aws greengrassv2 get-core-device --core-device-thing-name MeuCoreWSLDockerV2 --region us-east-1 --query 'status' --output text)
    echo "   Status: $STATUS"
    
    LAST_STATUS=$(aws greengrassv2 get-core-device --core-device-thing-name MeuCoreWSLDockerV2 --region us-east-1 --query 'lastStatusUpdateTimestamp' --output text)
    echo "   √öltima atualiza√ß√£o: $LAST_STATUS"
    
else
    echo "‚ùå Core Device n√£o encontrado"
    echo "üí° Verifique se o Greengrass Core foi instalado e registrado"
fi

# 5. Verificar Token Exchange Role
echo -e "\nüîê === VERIFICA√á√ÉO DA TOKEN EXCHANGE ROLE ==="
if aws iam get-role --role-name GreengrassV2TokenExchangeRole > /dev/null 2>&1; then
    echo "‚úÖ GreengrassV2TokenExchangeRole encontrada"
    
    # Verificar pol√≠ticas anexadas
    POLICIES=$(aws iam list-attached-role-policies --role-name GreengrassV2TokenExchangeRole --query 'AttachedPolicies[].PolicyName' --output text)
    echo "   Pol√≠ticas anexadas: $POLICIES"
    
else
    echo "‚ùå GreengrassV2TokenExchangeRole N√ÉO encontrada"
    echo "üí° Esta √© provavelmente a causa do problema!"
    echo "üí° Execute os comandos de cria√ß√£o da role do tutorial"
fi

# 6. Verificar associa√ß√£o da role
echo -e "\nüîó === VERIFICA√á√ÉO DA ASSOCIA√á√ÉO DA ROLE ==="
if aws greengrassv2 get-associated-role --region us-east-1 > /dev/null 2>&1; then
    ROLE_ARN=$(aws greengrassv2 get-associated-role --region us-east-1 --query 'RoleArn' --output text)
    echo "‚úÖ Role associada √† conta Greengrass"
    echo "   Role ARN: $ROLE_ARN"
else
    echo "‚ùå Nenhuma role associada √† conta Greengrass"
    echo "üí° Execute: aws greengrassv2 associate-service-role-to-account"
fi

# 7. Verificar deployments
echo -e "\nüöÄ === VERIFICA√á√ÉO DE DEPLOYMENTS ==="
DEPLOYMENTS=$(aws greengrassv2 list-deployments --target-arn "arn:aws:iot:us-east-1:864899849825:thing/MeuCoreWSLDockerV2" --region us-east-1 --query 'deployments' --output json)

if [ "$DEPLOYMENTS" != "[]" ]; then
    echo "‚úÖ Deployments encontrados:"
    
    # Pegar o deployment mais recente
    LATEST_DEPLOYMENT=$(echo $DEPLOYMENTS | jq -r '.[0].deploymentId')
    DEPLOYMENT_STATUS=$(echo $DEPLOYMENTS | jq -r '.[0].deploymentStatus')
    
    echo "   Deployment mais recente: $LATEST_DEPLOYMENT"
    echo "   Status: $DEPLOYMENT_STATUS"
    
    # Detalhes do deployment
    echo -e "\nüìã Detalhes do deployment:"
    aws greengrassv2 get-deployment --deployment-id $LATEST_DEPLOYMENT --region us-east-1 --query '{DeploymentStatus: deploymentStatus, Components: components}' --output table
    
else
    echo "‚ùå Nenhum deployment encontrado"
    echo "üí° Execute o comando de create-deployment"
fi

# 8. Verificar container Docker
echo -e "\nüê≥ === VERIFICA√á√ÉO DO CONTAINER DOCKER ==="
if docker ps --filter "name=greengrass-core-device" --format "table {{.Names}}\t{{.Status}}" | grep -q greengrass-core-device; then
    echo "‚úÖ Container greengrass-core-device est√° rodando"
    
    # Verificar logs b√°sicos
    echo "   √öltimas 5 linhas do log do container:"
    docker logs --tail 5 greengrass-core-device 2>/dev/null | sed 's/^/     /'
    
else
    echo "‚ùå Container greengrass-core-device N√ÉO est√° rodando"
    echo "üí° Execute: docker start greengrass-core-device"
fi

# 9. Verificar S3 bucket
echo -e "\nüóÇÔ∏è  === VERIFICA√á√ÉO DO S3 BUCKET ==="
if aws s3 ls s3://greengrass-v2-tutorial-giovanni > /dev/null 2>&1; then
    echo "‚úÖ Bucket S3 acess√≠vel"
    
    # Verificar artefatos
    echo "   Artefatos encontrados:"
    aws s3 ls s3://greengrass-v2-tutorial-giovanni/artifacts/ --recursive | head -5 | sed 's/^/     /'
    
else
    echo "‚ùå Bucket S3 n√£o acess√≠vel"
    echo "üí° Verifique as credenciais S3 e permiss√µes"
fi

# 10. Verificar componente
echo -e "\nüß© === VERIFICA√á√ÉO DO COMPONENTE ==="
COMPONENT_ARN="arn:aws:greengrass:us-east-1:864899849825:component:com.example.HelloWorldGreengrass"

# Listar vers√µes do componente
echo "üîÑ Verificando vers√µes do componente..."
VERSIONS=$(aws greengrassv2 list-component-versions --arn $COMPONENT_ARN --region us-east-1 --query 'componentVersions[].componentVersion' --output text 2>/dev/null)

if [ ! -z "$VERSIONS" ]; then
    echo "‚úÖ Componente encontrado com vers√µes: $VERSIONS"
    
    # Verificar a vers√£o mais recente
    LATEST_VERSION=$(echo $VERSIONS | tr ' ' '\n' | sort -V | tail -1)
    echo "   Vers√£o mais recente: $LATEST_VERSION"
    
    # Detalhes da vers√£o mais recente
    echo "   Detalhes da vers√£o $LATEST_VERSION:"
    aws greengrassv2 get-component --arn "${COMPONENT_ARN}:${LATEST_VERSION}" --region us-east-1 --query '{Recipe: recipe}' --output text | head -10 | sed 's/^/     /'
    
else
    echo "‚ùå Componente n√£o encontrado ou sem vers√µes"
    echo "üí° Execute: aws greengrassv2 create-component-version"
fi

# 11. Verificar logs no container (se estiver rodando)
echo -e "\nüìù === VERIFICA√á√ÉO DE LOGS ==="
if docker ps --filter "name=greengrass-core-device" --format "{{.Names}}" | grep -q greengrass-core-device; then
    echo "üîÑ Verificando logs no container..."
    
    # Verificar se logs existem
    echo "   Estrutura de logs:"
    docker exec greengrass-core-device find /greengrass/v2/logs -name "*.log" -type f 2>/dev/null | head -10 | sed 's/^/     /' || echo "     ‚ùå N√£o foi poss√≠vel acessar logs"
    
    # Verificar log do componente espec√≠fico
    echo "   Log do componente HelloWorldGreengrass:"
    if docker exec greengrass-core-device test -f /greengrass/v2/logs/com.example.HelloWorldGreengrass.log 2>/dev/null; then
        echo "     ‚úÖ Log do componente existe"
        docker exec greengrass-core-device tail -5 /greengrass/v2/logs/com.example.HelloWorldGreengrass.log 2>/dev/null | sed 's/^/       /' || echo "       ‚ö†Ô∏è N√£o foi poss√≠vel ler o log"
    else
        echo "     ‚ùå Log do componente n√£o encontrado"
    fi
    
    # Verificar log geral do Greengrass
    echo "   Log geral do Greengrass:"
    if docker exec greengrass-core-device test -f /greengrass/v2/logs/greengrass.log 2>/dev/null; then
        echo "     ‚úÖ Log geral existe"
        docker exec greengrass-core-device tail -3 /greengrass/v2/logs/greengrass.log 2>/dev/null | sed 's/^/       /' || echo "       ‚ö†Ô∏è N√£o foi poss√≠vel ler o log"
    else
        echo "     ‚ùå Log geral n√£o encontrado"
    fi
    
    # Verificar artefatos baixados
    echo "   Artefatos baixados:"
    docker exec greengrass-core-device find /greengrass/v2/packages/artifacts-unarchived -name "main.py" -type f 2>/dev/null | sed 's/^/     /' || echo "     ‚ùå main.py n√£o encontrado"
    
else
    echo "‚ùå Container n√£o est√° rodando - n√£o √© poss√≠vel verificar logs"
fi

# 12. Verificar endpoint IoT
echo -e "\nüåê === VERIFICA√á√ÉO DO ENDPOINT IOT ==="
IOT_ENDPOINT=$(aws iot describe-endpoint --endpoint-type iot:Data-ATS --region us-east-1 --query 'endpointAddress' --output text 2>/dev/null)
if [ ! -z "$IOT_ENDPOINT" ]; then
    echo "‚úÖ Endpoint IoT: $IOT_ENDPOINT"
    
    # Testar conectividade (ping b√°sico)
    if ping -c 1 $IOT_ENDPOINT > /dev/null 2>&1; then
        echo "   ‚úÖ Endpoint est√° acess√≠vel"
    else
        echo "   ‚ö†Ô∏è Endpoint pode n√£o estar acess√≠vel (isso √© normal em alguns casos)"
    fi
else
    echo "‚ùå N√£o foi poss√≠vel obter endpoint IoT"
fi

# 13. Resumo e recomenda√ß√µes
echo -e "\nüìä === RESUMO E RECOMENDA√á√ïES ==="

# Verificar problemas cr√≠ticos
CRITICAL_ISSUES=0

# Role Token Exchange
if ! aws iam get-role --role-name GreengrassV2TokenExchangeRole > /dev/null 2>&1; then
    echo "üö® CR√çTICO: GreengrassV2TokenExchangeRole n√£o existe"
    ((CRITICAL_ISSUES++))
fi

# Associa√ß√£o da role
if ! aws greengrassv2 get-associated-role --region us-east-1 > /dev/null 2>&1; then
    echo "üö® CR√çTICO: Role n√£o associada √† conta Greengrass"
    ((CRITICAL_ISSUES++))
fi

# Container rodando
if ! docker ps --filter "name=greengrass-core-device" --format "{{.Names}}" | grep -q greengrass-core-device; then
    echo "üö® CR√çTICO: Container Greengrass n√£o est√° rodando"
    ((CRITICAL_ISSUES++))
fi

# Core Device
if ! aws greengrassv2 get-core-device --core-device-thing-name MeuCoreWSLDockerV2 --region us-east-1 > /dev/null 2>&1; then
    echo "üö® CR√çTICO: Core Device n√£o est√° registrado"
    ((CRITICAL_ISSUES++))
fi

# Resultado final
if [ $CRITICAL_ISSUES -eq 0 ]; then
    echo -e "\n‚úÖ === DIAGN√ìSTICO GERAL: BOM ==="
    echo "   N√£o foram encontrados problemas cr√≠ticos."
    echo "   Se o componente n√£o est√° funcionando, verifique:"
    echo "   1. Logs do componente no container"
    echo "   2. Permiss√µes IPC no recipe.json"
    echo "   3. MQTT Test Client no console AWS"
else
    echo -e "\n‚ùå === DIAGN√ìSTICO GERAL: PROBLEMAS ENCONTRADOS ==="
    echo "   $CRITICAL_ISSUES problema(s) cr√≠tico(s) encontrado(s)."
    echo "   Corrija os problemas marcados como üö® CR√çTICO primeiro."
fi

echo -e "\nüõ†Ô∏è  === PR√ìXIMOS PASSOS RECOMENDADOS ==="
echo "1. Se h√° problemas cr√≠ticos: corrija-os primeiro usando o tutorial limpo"
echo "2. Se n√£o h√° problemas cr√≠ticos:"
echo "   a) Verifique logs: docker exec -it greengrass-core-device tail -f /greengrass/v2/logs/com.example.HelloWorldGreengrass.log"
echo "   b) Verifique MQTT Test Client no console AWS IoT Core"
echo "   c) Subscribe nos t√≥picos: greengrass/v2/hello e test/greengrass/hello"
echo "3. Para debug avan√ßado: execute o script main.py otimizado"

echo -e "\n=========================================================="
echo "üèÅ Diagn√≥stico completo finalizado em $(date)"
echo "=========================================================="

